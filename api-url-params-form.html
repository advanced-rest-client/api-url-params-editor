<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-if.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-validatable-behavior/iron-validatable-behavior.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../marked-element/marked-element.html">
<link rel="import" href="../api-property-form-item/api-property-form-item.html">
<link rel="import" href="../markdown-styles/markdown-styles.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../arc-icons/arc-icons.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="api-url-params-custom-input.html">

<dom-module id="api-url-params-form">
  <template strip-whitespace>
    <style include="markdown-styles">
    :host {
      display: block;
      @apply --raml-request-parameters-form;
      @apply --api-url-params-form;
    }

    .param-value {
      @apply --raml-request-parameters-editor-row;
      @apply --api-url-params-form-row;
    }

    .param-value.optional {
      display: none;
    }

    .param-value.required {
      @apply --api-url-params-form-required;
    }

    .param-value.optional.with-optional {
      display: block;
    }

    .param-value .input {
      @apply --layout-horizontal;
      @apply --layout-flex;
    }

    .docs {
      @apply --arc-font-body1;
      color: var(--inline-documentation-color, rgba(0, 0, 0, 0.87));
      margin-right: 40px;
    }

    .has-enable-button .docs {
      margin-left: 32px;
    }

    marked-element {
      background-color: var(--inline-documentation-background-color, #FFF3E0);
      padding: 4px;
    }

    .value-input {
      @apply --layout-horizontal;
      @apply --layout-start;
      @apply --layout-flex;
    }

    .value-input.is-array {
      @apply --layout-end;
      @apply --raml-request-parameters-form-array-parameter;
      @apply --api-url-params-form-array-parameter;
    }

    api-property-form-item,
    api-url-params-custom-input {
      @apply --layout-flex;
      margin-bottom: 8px;
    }

    api-property-form-item[is-array] {
      margin-top: 8px;
    }

    [hidden] {
      display: none !important;
    }

    .enable-checkbox {
      margin-top: 32px;
      margin-right: 8px;
    }

    h3 {
      @apply --raml-request-parameters-editor-subheader;
      @apply --api-url-params-editor-editor-subheader;
    }

    .params-title {
      @apply --layout-horizontal;
      @apply --layout-center;
    }

    .params-title h3 {
      display: inline-block;
      margin-right: 12px;
    }

    .toggle-checkbox {
      --paper-checkbox-label-color: var(--api-url-params-editor-optional-checkbox-label-color, rgba(0, 0, 0, 0.74));
    }

    .action-button {
      margin: 0;
      color: var(--api-url-params-form-action-button-color, var(--secondary-button-color, var(--accent-color)));
      background: var(--raml-headers-form-action-button-background, var(--secondary-button-background, #fff));
      @apply --secondary-button;
      @apply --raml-headers-form-action-button;
    }

    .action-button:hover {
      color: var(--raml-headers-form-action-button-color-hover, var(--secondary-button-color, var(--accent-color)));
      background: var(--raml-headers-form-action-button-background-hover, var(--secondary-button-background, #fff));
      @apply --secondary-button-hover;
      @apply --raml-headers-form-action-button-hover;
    }

    .action-button .action-icon {
      margin-right: 12px;
      color: var(--api-url-params-form-action-button-color, var(--secondary-button-color, var(--accent-color)));
    }

    .action-button:hover .action-icon {
      color: var(--raml-headers-form-action-button-color-hover, var(--secondary-button-color, var(--accent-color)));
    }

    .hint-icon {
      margin-top: 16px;
      color: var(--hint-trigger-color, rgba(0, 0, 0, 0.74));
      transition: color 0.25s linear;
      @apply --icon-button;
    }

    .hint-icon:hover {
      color: var(--hint-trigger-hover-color, var(--accent-color, rgba(0, 0, 0, 0.88)));
      @apply --icon-button-hover;
    }

    .action-icon {
      color: var(--from-row-action-icon-color, var(--icon-button-color, rgba(0, 0, 0, 0.74)));
      transition: opacity 0.2s ease-in-out, color 0.2s ease-in-out;
    }

    .action-icon:hover {
      color: var(--from-row-action-icon-color-hover, var(--accent-color, rgba(0, 0, 0, 0.88)));
    }

    .delete-icon {
      margin-top: 16px;
    }
    </style>
    <div class="params-title">
      <h3 id$="[[_titleId]]">[[formTitle]]</h3>
      <template is="dom-if" if="[[_renderOptionalCheckbox]]">
        <paper-checkbox class="toggle-checkbox" checked="{{optionalOpened}}" title="Shows or hides optional parameters">Show optional parameters</paper-checkbox>
      </template>
    </div>
    <iron-form>
      <form enctype="application/json">
        <dom-repeat items="{{model}}" items-repeater>
          <template>
            <div class$="[[_computeRowClass(item, allowHideOptional, optionalOpened, allowDisableParams)]]">
              <div class$="value-input [[_computeTypeClass(item.isArray)]]">
                <template is="dom-if" if="[[allowDisableParams]]">
                  <paper-checkbox class="enable-checkbox" checked="{{item.schema.enabled}}" title="Enable/disable this header"></paper-checkbox>
                </template>
                <template is="dom-if" if="[[!_computeIsCustom(item.schema)]]">
                  <api-property-form-item
                    model="[[item]]"
                    name="[[item.name]]"
                    value="{{item.value}}"
                    required$="[[item.required]]"></api-property-form-item>
                </template>
                <template is="dom-if" if="[[_computeIsCustom(item.schema)]]">
                  <api-url-params-custom-input
                    model="[[item]]"
                    name="{{item.name}}"
                    value="{{item.value}}"
                    required$="[[item.required]]"
                    narrow="[[narrow]]"></api-url-params-custom-input>
                </template>
                <template is="dom-if" if="[[_computeHasDocumentation(item)]]">
                  <paper-icon-button class="hint-icon" icon="arc:help" on-tap="_openDocs" title="Display documentation"></paper-icon-button>
                </template>
                <template is="dom-if" if="[[_computeIsCustom(item.schema)]]">
                  <paper-icon-button title="Remove parameter" class="delete-icon action-icon" icon="arc:remove-circle-outline" on-tap="_removeCustom"></paper-icon-button>
                </template>
              </div>
              <template is="dom-if" if="[[_computeHasDocumentation(item)]]">
                <div class="docs">
                  <iron-collapse>
                    <marked-element markdown="[[_computeDocumentation(item)]]">
                      <div slot="markdown-html" class="markdown-body"></div>
                    </marked-element>
                  </iron-collapse>
                </div>
              </template>
            </div>
          </template>
        </dom-repeat>
      </form>
    </iron-form>
    <template is="dom-if" if="[[allowCustom]]">
      <div class="add-action">
        <paper-button class="action-button" on-tap="addCustom">
          <iron-icon class="action-icon" icon="arc:add-circle-outline"></iron-icon>
          Add query parameter
        </paper-button>
      </div>
    </template>
  </template>
  <script>
  if (!window.ArcBehaviors) {
    window.ArcBehaviors = {};
  }
  if (!window.ArcBehaviors.DomHelper) {
    window.ArcBehaviors.DomHelper = {
      NextID: 1
    };
  }
  /**
   * Renders form and input elements for query / uri model.
   *
   * Handles creation of form elements, validation, and rendering documentation.
   *
   * This element **requires** you to set `form-type` attribute to either
   * `uri` or `query` to distinguish type of form. Also, set `form-title`
   * property to render a title. It is useful when adding two forms right after
   * each other.
   *
   * ## Optional parameters
   *
   * By default the element renders all form valus. For better user experience,
   * set `allow-hide-optional` attribute to hide parameters that are optional.
   * It also renders checkbox to toggle optional parameters.
   *
   * Styling
   *
   * Custom property | Description | Default
   * ----------------|-------------|----------
   * `--api-url-params-form` | Mixin applied to this element | `{}`
   * `--api-url-params-form-row` | Mixin applied to each form row | `{}`
   * `--api-url-params-form-required` | Mixin applied to a form row that is required | `{}`
   * `--inline-documentation-color` | Color of the documentation when opened. | `rgba(0, 0, 0, 0.87)`
   * `--from-row-action-icon-color` | Color of the documentation icon | `--icon-button-color` or `rgba(0, 0, 0, 0.74)`
   * `--from-row-action-icon-color-hover` | Color of the documentation icon when hovering. Please, consider devices that do not support hovers. | `--accent-color` or `rgba(0, 0, 0, 0.74)`
   * `--inline-documentation-background-color` | Background color of opened documentation. | `#FFF3E0`
   * `--api-url-params-form-array-parameter` | Mixin applied to a container of a parameter that is an array | `{}`
   * `--api-url-params-editor-editor-subheader` | Mixin applied to the form header element | `{}`
   * `--api-url-params-editor-optional-checkbox-label-color,` | Label color of toggle optional checkbox | `rgba(0, 0, 0, 0.74)`
   * `--hint-trigger-color` | Color of the help icon | `rgba(0, 0, 0, 0.74)`
   * `--hint-trigger-hover-color` | Color of the help icon when hovering | `rgba(0, 0, 0, 0.88)`
   * `--icon-button` | Mixin applied to all icon buttons | `{}`
   * `--icon-button-hover` | Mixin applied to all icon buttons when hovering | `{}`
   *
   * You can also style inputs as defined in
   * [api-property-form-item](https://github.com/advanced-rest-client/api-property-form-item)
   * element documentation.
   *
   * @customElement
   * @polymer
   * @demo demo/index.html
   * @memberof ApiElements
   * @appliesMixin Polymer.IronValidatableBehavior
   */
  class ApiUrlParamsForm extends
  Polymer.mixinBehaviors([Polymer.IronValidatableBehavior], Polymer.Element) {
    static get is() {
      return 'api-url-params-form';
    }
    static get properties() {
      return {
        /**
         * View model to use to render the form.
         * See `api-url-params-editor` element for more information.
         */
        model: {
          type: Array,
          notify: true
        },
        /**
         * Computed value, set to true to show optional parameters (not required by the API)
         */
        optionalOpened: {
          type: Boolean,
          value: false
        },
        /**
         * The form can display query or URI parameters. When anything change in the form
         * it will send a corresponding custom event (`query-parameter-changed` or
         * `uri-parameter-changed`). To make this happen set the value of this property to
         * either `query` or `uri`.
         */
        formType: String,
        /**
         * Computed value. True if current query parameters set has any
         * optional value.
         */
        hasOptional: {
          type: Boolean,
          computed: '_computeHasOptionalParameters(allowHideOptional, model.*)',
          notify: true
        },
        /**
         * If set it computes `hasOptional` property and shows checkbox
         * to show / hide optional properties.
         */
        allowHideOptional: Boolean,
        /**
         * Computed flag to determine if optional checkbox can be rendered
         */
        _renderOptionalCheckbox: {
          type: Boolean,
          computed: '_computeRenderCheckbox(allowHideOptional, hasOptional)'
        },
        /**
         * Title do render
         */
        formTitle: String,
        // Generated ID of the title element.
        _titleId: String,
        /**
         * If set, enable / disable param checkbox is rendered.
         */
        allowDisableParams: Boolean,
        /**
         * When set, renders add custom parameter button
         */
        allowCustom: Boolean,
        /**
         * Renders items in "narrow" view
         */
        narrow: Boolean
      };
    }

    connectedCallback() {
      super.connectedCallback();
      this._generateTitleId();
      this._ensureAttribute('role', 'form');
    }
    /**
     * Generates ``
     * @return {[type]} [description]
     */
    _generateTitleId() {
      if (!this._titleId || this._titleId === '') {
        this._titleId =  'arc-id-' + window.ArcBehaviors.DomHelper.NextID++;
      }
    }
    /**
     * Computes class name for each row depending on the item.
     *
     * @param {Object} item Model item
     * @param {Boolean} allowHideOptional
     * @param {Boolean} optionalOpened True if optional parameters are rendered.
     * @param {Boolean} allowDisableParams
     * @return {String}
     */
    _computeRowClass(item, allowHideOptional, optionalOpened, allowDisableParams) {
      let clazz = 'param-value';
      if (item.required) {
        clazz += ' required';
      } else if (allowHideOptional) {
        clazz += ' optional';
      }
      if (optionalOpened) {
        clazz += ' with-optional';
      }
      if (allowDisableParams) {
        clazz += ' has-enable-button';
      }
      return clazz;
    }

    /**
     * Computes array class for the input element.
     */
    _computeTypeClass(isArray) {
      return isArray ? 'is-array' : '';
    }

    /**
     * Toggles visibility of optional parameters.
     */
    toggleOptionalParams() {
      if (!this.allowHideOptional) {
        return;
      }
      this.optionalOpened = !this.optionalOpened;
    }
    /**
     * Returns a reference to the form element, if the DOM is ready.
     *
     * @return {IronForm} Iron form element
     */
    _getForm() {
      if (!this.$) {
        this.$ = {};
      }
      if (!this.$.form && this.shadowRoot) {
        this.$.form = this.shadowRoot.querySelector('iron-form');
      }
      return this.$.form;
    }

    // Overidden from Polymer.IronValidatableBehavior. Will set the `invalid`
    // attribute automatically, which should be used for styling.
    _getValidity() {
      return this._getForm().validate();
    }
    // Link to the form's serialize function.
    serializeForm() {
      return this._getForm().serializeForm();
    }
    // Opens the documentation for item.
    _openDocs(e) {
      const form = this._getForm();
      const template = form.querySelector('[items-repeater]');
      const model = template.modelForElement(e.target);
      const collapse = form.querySelector('.param-value:nth-child(' + (model.index + 1) +
        ') iron-collapse');
      if (!collapse) {
        return;
      }
      collapse.opened = !collapse.opened;
    }
    /**
     * Computes if any of the query parameters are required.
     */
    _computeHasOptionalParameters(allowHideOptional, record) {
      if (!allowHideOptional || !record.base || !record.path) {
        return false;
      }
      if (record.path !== 'model' && record.path !== 'model.splices') {
        return this.hasOptional;
      }

      for (let i = 0, len = record.base.length; i < len; i++) {
        if (!record.base[i].required) {
          return true;
        }
      }
      return false;
    }

    _computeRenderCheckbox(render, has) {
      return render && has;
    }
    /**
     * Computes documentation as a markdown to be placed in the `marked-element`
     * @param {Object} item View model
     */
    _computeDocumentation(item) {
      let docs = '';
      if (item.description) {
        docs += item.description;
      }
      if (!item.schema) {
        return docs;
      }
      const schema = item.schema;
      docs += '\n\n\n';
      if (schema.pattern) {
        docs += '- Pattern: `' + schema.pattern + '`\n';
      }
      if (schema.examples && schema.examples.length) {
        schema.examples.forEach((item) => {
          docs += '- Example';
          if (item.hasName) {
            docs += ' ' + item.name;
          }
          docs += ': `' + item.value + '`\n';
        });
      }
      return docs;
    }
    /**
     * Computes if model item has documentation to display.
     *
     * @param {Object} item Model item
     * @return {Boolean} True if documentation can be rendered.
     */
    _computeHasDocumentation(item) {
      if (item.hasDescription) {
        return true;
      }
      if (!item.schema) {
        return false;
      }
      const schema = item.schema;
      if (schema.pattern) {
        return true;
      }
      if (schema.examples && schema.examples.length) {
        return true;
      }
      return false;
    }

    _computeIsCustom(schema) {
      if (!schema || !schema.isCustom) {
        return false;
      }
      return true;
    }
    /**
     * Adds custom property to the list.
     */
    addCustom() {
      const e = this.fire('api-property-model-build', {
        name: '',
        value: '',
        binding: 'query',
        schema: {
          enabled: true,
          isCustom: true
        }
      });
      if (this.model) {
        this.push('model', e.detail);
      } else {
        this.set('model', [e.detail]);
      }
      this.optionalOpened = true;
    }
    /**
     * Removed custom item from the UI.
     *
     * @param {CustomEvent} e
     */
    _removeCustom(e) {
      this.splice('model', e.model.get('index'), 1);
    }
  }

  window.customElements.define(ApiUrlParamsForm.is, ApiUrlParamsForm);
  </script>
</dom-module>
