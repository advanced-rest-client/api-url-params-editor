<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-if.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-validatable-behavior/iron-validatable-behavior.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../marked-element/marked-element.html">
<link rel="import" href="../api-property-form-item/api-property-form-item.html">

<dom-module id="api-url-params-form">
  <template strip-whitespace>
    <style>
    :host {
      display: block;
      @apply --raml-request-parameters-form;
      @apply --api-url-params-form;
    }

    .param-value {
      @apply --raml-request-parameters-editor-row;
      @apply --api-url-params-form-row;
    }

    .param-value.optional {
      display: none;
    }

    .param-value.required {
      @apply --api-url-params-form-required;
    }

    .param-value.optional.with-optional {
      display: block;
    }

    .param-value .input {
      @apply --layout-horizontal;
      @apply --layout-flex;
    }

    .docs {
      @apply --arc-font-common-base;
      font-size: 13px !important;
      font-weight: 200;
      line-height: 24px;
      margin-left: 24px;
      color: var(--inline-documentation-color, rgba(0, 0, 0, 0.87));
    }

    .markdown-html * {
      font-size: 13px !important;
    }

    .markdown-html p:first-child {
      margin-top: 0;
      padding-top: 0;
    }

    .markdown-html p:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .help-icon {
      margin-top: 16px;
      color: var(--from-row-action-icon-color, var(--icon-button-color, rgba(0, 0, 0, 0.74)));
      transition: color 0.2s linear;
    }

    .help-icon:hover {
      color: var(--from-row-action-icon-color-hover, var(--accent-color, rgba(0, 0, 0, 0.74)));
    }

    .value-input {
      @apply --layout-horizontal;
      @apply --layout-start;
      @apply --layout-flex;
    }

    .value-input.is-array {
      @apply --layout-end;
      @apply --raml-request-parameters-form-array-paramtere;
    }

    .optional-toggle-button {
      font-size: 13px;
      @apply --raml-request-parameters-form-optional-toggle-button;
    }

    api-property-form-item {
      @apply --layout-flex;
      margin-bottom: 8px;
    }

    api-property-form-item[is-array] {
      margin-top: 8px;
    }

    [hidden] {
      display: none !important;
    }

    .enable-checkbox {
      margin-top: 32px;
      margin-right: 8px;
    }

    h3 {
      @apply --raml-request-parameters-editor-subheader;
      @apply --api-url-params-editor-editor-subheader;
    }

    .params-title {
      @apply --layout-horizontal;
      @apply --layout-center;
    }

    .params-title h3 {
      display: inline-block;
      margin-right: 12px;
    }

    .params-title paper-checkbox {
      --paper-checkbox-label-color: var(--api-url-params-editor-optional-checkbox-label-color, rgba(0, 0, 0, 0.54));
    }
    </style>
    <div class="params-title">
      <h3 id$="[[_titleId]]">[[formTitle]]</h3>
      <template is="dom-if" if="[[_renderOptionalCheckbox]]">
        <paper-checkbox checked="{{optionalOpened}}" title="Shows or hides optional parameters">Show optional parameters</paper-checkbox>
      </template>
    </div>
    <iron-form>
      <form enctype="application/json">
        <dom-repeat items="{{model}}" items-repeater>
          <template>
            <div class$="[[_computeRowClass(item, allowHideOptional, optionalOpened)]]">
              <div class$="value-input [[_computeTypeClass(item.isArray)]]">
                <span>
                  <paper-checkbox class="enable-checkbox" checked="{{item.schema.enabled}}" title="Enable/disable this header"></paper-checkbox>
                </span>
                <api-property-form-item
                  model="[[item]]"
                  name="[[item.name]]"
                  value="{{item.value}}"
                  required$="[[item.required]]"></api-property-form-item>
                <template is="dom-if" if="[[item.hasDescription]]">
                  <span>
                    <paper-icon-button class="help-icon" suffix icon="arc:help" on-tap="_openDocs" title="Display documentation"></paper-icon-button>
                  </span>
                </template>
              </div>
              <template is="dom-if" if="[[item.hasDescription]]">
                <div class="docs">
                  <iron-collapse>
                    <marked-element markdown="[[item.description]]">
                      <div class="markdown-html markdown-body"></div>
                    </marked-element>
                  </iron-collapse>
                </div>
              </template>
            </div>
          </template>
        </dom-repeat>
      </form>
    </iron-form>
  </template>
  <script>
  if (!window.ArcBehaviors) {
    window.ArcBehaviors = {};
  }
  if (!window.ArcBehaviors.DomHelper) {
    window.ArcBehaviors.DomHelper = {
      NextID: 1
    };
  }
  /**
   *
   *
   *
   * @customElement
   * @polymer
   * @demo demo/index.html
   * @memberof ApiElements
   * @appliesMixin Polymer.IronValidatableBehavior
   */
  class ApiUrlParamsForm extends Polymer.mixinBehaviors([Polymer.IronValidatableBehavior], Polymer.Element) {
    static get is() {
      return 'api-url-params-form';
    }
    static get properties() {
      return {
        /**
         * View model to use to render the form.
         * See `api-url-params-editor` element for more information.
         */
        model: Array,
        /**
         * Computed value, set to true to show optional parameters (not required by the API)
         */
        optionalOpened: {
          type: Boolean,
          value: false
        },
        /**
         * The form can display query or URI parameters. When anything change in the form
         * it will send a corresponding custom event (`query-parameter-changed` or
         * `uri-parameter-changed`). To make this happen set the value of this property to
         * either `query` or `uri`.
         */
        formType: String,
        /**
         * Computed value. True if current query parameters set has any
         * optional value.
         */
        hasOptional: {
          type: Boolean,
          computed: '_computeHasOptionalParameters(allowHideOptional, model)',
          notify: true
        },
        /**
         * If set it computes `hasOptional` property and shows checkbox
         * to show / hide optional properties.
         */
        allowHideOptional: Boolean,
        /**
         * Computed flag to determine if optional checkbox can be rendered
         */
        _renderOptionalCheckbox: {
          type: Boolean,
          computed: '_computeRenderCheckbox(allowHideOptional, hasOptional)'
        },
        /**
         * Title do render
         */
        formTitle: String,
        // Generated ID of the title element.
        _titleId: String
      };
    }

    connectedCallback() {
      super.connectedCallback();
      this._generateTitleId();
      this._ensureAttribute('role', 'form');
      this._ensureAttribute('aria-labelledby', this._titleId);
    }
    /**
     * Generates ``
     * @return {[type]} [description]
     */
    _generateTitleId() {
      if (!this._titleId || this._titleId === '') {
        this._titleId =  'arc-id-' + window.ArcBehaviors.DomHelper.NextID++;
      }
    }
    /**
     * Computes class name for each row depending on the item.
     *
     * @param {Object} item Model item
     * @param {Boolean} allowHideOptional
     * @param {Boolean} optionalOpened True if optional parameters are rendered.
     * @return {String}
     */
    _computeRowClass(item, allowHideOptional, optionalOpened) {
      let clazz = 'param-value';
      if (item.required) {
        clazz += ' required';
      } else if (allowHideOptional) {
        clazz += ' optional';
      }
      if (optionalOpened) {
        clazz += ' with-optional';
      }
      return clazz;
    }

    /**
     * Computes array class for the input element.
     */
    _computeTypeClass(isArray) {
      return isArray ? 'is-array' : '';
    }

    /**
     * Toggles visibility of optional parameters.
     */
    toggleOptionalParams() {
      this.optionalOpened = !this.optionalOpened;
    }
    /**
     * Returns a reference to the form element, if the DOM is ready.
     *
     * @return {IronForm} Iron form element
     */
    _getForm() {
      if (!this.$) {
        this.$ = {};
      }
      if (!this.$.form && this.shadowRoot) {
        this.$.form = this.shadowRoot.querySelector('iron-form');
      }
      return this.$.form;
    }

    // Overidden from Polymer.IronValidatableBehavior. Will set the `invalid`
    // attribute automatically, which should be used for styling.
    _getValidity() {
      return this._getForm().validate();
    }
    // Link to the form's serialize function.
    serializeForm() {
      return this._getForm().serializeForm();
    }
    // Opens the documentation for item.
    _openDocs(e) {
      const form = this._getForm();
      const template = form.querySelector('[items-repeater]');
      const model = template.modelForElement(e.target);
      const collapse = form.querySelector('.param-value:nth-child(' + (model.index + 1) +
        ') iron-collapse');
      if (!collapse) {
        return;
      }
      collapse.opened = !collapse.opened;
    }
    /**
     * Computes if any of the query parameters are required.
     */
    _computeHasOptionalParameters(allowHideOptional, model) {
      if (!allowHideOptional || !model) {
        return false;
      }
      for (let i = 0, len = model.length; i < len; i++) {
        if (!model[i].required) {
          return true;
        }
      }
      return false;
    }

    _computeRenderCheckbox(render, has) {
      return render && has;
    }
  }

  window.customElements.define(ApiUrlParamsForm.is, ApiUrlParamsForm);
  </script>
</dom-module>
