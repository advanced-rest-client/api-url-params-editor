<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
    <title>api-url-params-editor test</title>
    <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <link rel="import" href="../api-url-params-form.html">
  </head>
  <body>
    <test-fixture id="basic">
      <template>
        <api-url-params-form></api-url-params-form>
      </template>
    </test-fixture>

    <script>
      suite('api-url-params-form', () => {

        suite('_generateTitleId()', () => {
          let element;
          suiteSetup(() => {
            element = fixture('basic');
          });

          test('Creates property _titleId', () => {
            element._generateTitleId();
            assert.isTrue(element._titleId.indexOf('arc-id-') === 0);
          });

          test('Increqases helper value', () => {
            const before = ArcBehaviors.DomHelper.NextID;
            element._generateTitleId();
            assert.equal(ArcBehaviors.DomHelper.NextID, before + 1);
          });
        });

        suite('_computeRowClass()', () => {
          let element;
          suiteSetup(() => {
            element = fixture('basic');
          });

          test('Returns only container class', () => {
            let result = element._computeRowClass({});
            assert.equal(result, 'param-value');
          });

          test('Returns class for required', () => {
            let result = element._computeRowClass({required: true});
            assert.equal(result, 'param-value required');
          });

          test('If required then not optional', () => {
            let result = element._computeRowClass({required: true}, true);
            assert.equal(result, 'param-value required');
          });

          test('Returns optional name', () => {
            let result = element._computeRowClass({required: false}, true);
            assert.equal(result, 'param-value required');
          });

          test('Ignores optional if can\'t has optional', () => {
            let result = element._computeRowClass({required: false}, false);
            assert.equal(result, 'param-value');
          });

          test('Has opened class', () => {
            let result = element._computeRowClass({}, true, true);
            assert.equal(result, 'param-value required with-optional');
          });
        });

        suite('_computeTypeClass()', () => {
          let element;
          suiteSetup(() => {
            element = fixture('basic');
          });

          test('Returns "is-array" class', () => {
            let result = element._computeTypeClass(true);
            assert.equal(result, 'is-array');
          });

          test('Returns empty class', () => {
            let result = element._computeTypeClass(false);
            assert.equal(result, '');
          });
        });

        suite('toggleOptionalParams()', () => {
          let element;
          suiteSetup(() => {
            element = fixture('basic');
          });

          test('Ignores the state when allowHideOptional is not set', () => {
            element.toggleOptionalParams();
            assert.isFalse(element.optionalOpened);
            element.toggleOptionalParams();
            assert.isFalse(element.optionalOpened);
          });

          test('Toggles property when allowed', () => {
            element.allowHideOptional = true;
            element.toggleOptionalParams();
            assert.isTrue(element.optionalOpened);
            element.toggleOptionalParams();
            assert.isFalse(element.optionalOpened);
          });
        });

        suite('Basics', () => {
          let element;
          setup(() => {
            element = fixture('basic');
          });

          test('_getForm() returns form handler', () => {
            const result = element._getForm();
            assert.isOk(result);
          });

          test('Empty info is rendered', () => {
            const section = element.shadowRoot.querySelector('.empty-message');
            const display = getComputedStyle(section).display;
            assert.notEqual(display, 'none');
          });

          test('uriValue is undefined', () => {
            assert.isUndefined(element.uriValue);
          });

          test('queryValue is undefined', () => {
            assert.isUndefined(element.queryValue);
          });
        });

        suite('With model', () => {
          const uriModel = {
            binding: 'query',
            name: 'file',
            hasDescription: true,
            description: 'test',
            required: true,
            schema: {
              enabled: true,
              type: 'string',
              inputLabel: 'file',
              isEnum: false,
              isArray: false,
              isBool: false,
              inputType: 'text'
            },
            value: 'file-test-value'
          };
          const queryModel = {
            binding: 'query',
            name: 'access_token',
            hasDescription: true,
            description: 'test',
            required: true,
            schema: {
              enabled: true,
              type: 'string',
              inputLabel: 'access_token',
              isEnum: false,
              isArray: false,
              isBool: false,
              inputType: 'text'
            },
            value: 'access_token-value'
          };
          let element;
          setup(() => {
            element = fixture('BasicTestFixture');
          });

          test('Computes hasUriParameters', () => {
            element.uriModel = [Object.assign({}, uriModel)];
            assert.isTrue(element.hasUriParameters);
          });

          test('Computes hasParameters when uri model is set', () => {
            element.uriModel = [Object.assign({}, uriModel)];
            assert.isTrue(element.hasParameters);
          });

          test('Renders uri parameters form', (done) => {
            element.uriModel = [Object.assign({}, uriModel)];
            flush(() => {
              const form = element.shadowRoot.querySelector('api-url-params-form[form-type="uri"]');
              assert.ok(form);
              done();
            });
          });

          test('Computes hasQueryParameters', () => {
            element.queryModel = [Object.assign({}, queryModel)];
            assert.isTrue(element.hasQueryParameters);
          });

          test('Computes hasParameters when query model is set', () => {
            element.queryModel = [Object.assign({}, queryModel)];
            assert.isTrue(element.hasParameters);
          });

          test('Renders query parameters form', (done) => {
            element.queryModel = [Object.assign({}, queryModel)];
            flush(() => {
              const form = element.shadowRoot.querySelector('api-url-params-form[form-type="query"]');
              assert.ok(form);
              done();
            });
          });

          test('Dispatches change event when uri params are set', (done) => {
            element.addEventListener('uri-parameter-changed', (e) => {
              assert.equal(e.detail.name, 'file', 'name is set');
              assert.equal(e.detail.value, 'file-test-value', 'value is set');
              assert.isTrue(e.detail.enabled, 'enabled is set');
              done();
            });
            element.uriModel = [Object.assign({}, uriModel)];
          });

          test('Dispatches change event when uri value change', (done) => {
            element.uriModel = [Object.assign({}, uriModel)];
            element.addEventListener('uri-parameter-changed', (e) => {
              assert.equal(e.detail.name, 'file', 'name is set');
              assert.equal(e.detail.value, 'changed-value', 'value is set');
              assert.isTrue(e.detail.enabled, 'enabled is set');
              done();
            });
            element.set(['uriModel', 0, 'value'], 'changed-value');
          });

          test('Dispatches change event when uri enabled change', (done) => {
            element.uriModel = [Object.assign({}, uriModel)];
            element.addEventListener('uri-parameter-changed', (e) => {
              assert.equal(e.detail.name, 'file', 'name is set');
              // assert.isUndefined(e.detail.value, 'value is undefined');
              assert.isFalse(e.detail.enabled, 'enabled is set');
              done();
            });
            element.set('uriModel.0.schema.enabled', false);
          });

          test('Dispatches change event when query params are set', (done) => {
            element.addEventListener('query-parameter-changed', (e) => {
              assert.equal(e.detail.name, 'access_token', 'name is set');
              assert.equal(e.detail.value, 'access_token-value', 'value is set');
              assert.isTrue(e.detail.enabled, 'enabled is set');
              done();
            });
            element.queryModel = [Object.assign({}, queryModel)];
          });

          test('Dispatches change event when query value change', (done) => {
            element.queryModel = [Object.assign({}, queryModel)];
            element.addEventListener('query-parameter-changed', (e) => {
              assert.equal(e.detail.name, 'access_token', 'name is set');
              assert.equal(e.detail.value, 'changed-value', 'value is set');
              assert.isTrue(e.detail.enabled, 'enabled is set');
              done();
            });
            element.set(['queryModel', 0, 'value'], 'changed-value');
          });

          test('Dispatches change event when query enabled change', (done) => {
            element.queryModel = [Object.assign({}, queryModel)];
            element.addEventListener('query-parameter-changed', (e) => {
              assert.equal(e.detail.name, 'access_token', 'name is set');
              // assert.isUndefined(e.detail.value, 'value is undefined');
              assert.isFalse(e.detail.enabled, 'enabled is set');
              done();
            });
            element.set('queryModel.0.schema.enabled', false);
          });

          test('uriValue is computed', () => {
            uriModel.schema.enabled = true;
            element.uriModel = [Object.assign({}, uriModel)];
            assert.typeOf(element.uriValue, 'object');
            assert.equal(element.uriValue.file, 'file-test-value');
          });

          test('Not enabled uri parameters are not included', () => {
            uriModel.schema.enabled = false;
            element.uriModel = [Object.assign({}, uriModel)];
            assert.typeOf(element.uriValue, 'object');
            assert.isUndefined(element.uriValue.file);
          });

          test('queryValue is computed', () => {
            queryModel.schema.enabled = true;
            element.queryModel = [Object.assign({}, queryModel)];
            assert.typeOf(element.queryValue, 'object');
            assert.equal(element.queryValue.access_token, 'access_token-value');
          });

          test('Not enabled query parameters are not included', () => {
            queryModel.schema.enabled = false;
            element.queryModel = [Object.assign({}, queryModel)];
            assert.typeOf(element.queryValue, 'object');
            assert.isUndefined(element.queryValue.access_token);
          });
        });

        a11ySuite('BasicTestFixture');
      });
    </script>

  </body>
</html>
