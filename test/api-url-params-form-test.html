<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
    <title>api-url-params-editor test</title>
    <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../iron-test-helpers/mock-interactions.js"></script>
    <link rel="import" href="../api-url-params-form.html">
  </head>
  <body>
    <test-fixture id="basic">
      <template>
        <api-url-params-form></api-url-params-form>
      </template>
    </test-fixture>

    <test-fixture id="withTitle">
      <template>
        <api-url-params-form form-title="test-title"></api-url-params-form>
      </template>
    </test-fixture>

    <test-fixture id="allowHideOptional">
      <template>
        <api-url-params-form allow-hide-optional></api-url-params-form>
      </template>
    </test-fixture>

    <test-fixture id="uriModel">
      <template>
        <api-url-params-form></api-url-params-form>
      </template>
    </test-fixture>

    <test-fixture id="queryModel">
      <template>
        <api-url-params-form allow-hide-optional></api-url-params-form>
      </template>
    </test-fixture>

    <test-fixture id="custom">
      <template>
        <api-url-params-form allow-custom></api-url-params-form>
      </template>
    </test-fixture>

    <script>
      /* global MockInteractions, a11ySuite */
      suite('api-url-params-form', () => {

        a11ySuite('basic');

        suite('_generateTitleId()', () => {
          let element;
          suiteSetup(() => {
            element = fixture('basic');
          });

          test('Creates property _titleId', () => {
            element._generateTitleId();
            assert.isTrue(element._titleId.indexOf('arc-id-') === 0);
          });

          test('Increases helper value', () => {
            const before = ArcBehaviors.DomHelper.NextID;
            element._titleId = undefined;
            element._generateTitleId();
            assert.equal(ArcBehaviors.DomHelper.NextID, before + 1);
          });
        });

        suite('_computeRowClass()', () => {
          let element;
          suiteSetup(() => {
            element = fixture('basic');
          });

          test('Returns only container class', () => {
            let result = element._computeRowClass({});
            assert.equal(result, 'param-value');
          });

          test('Returns class for required', () => {
            let result = element._computeRowClass({required: true});
            assert.equal(result, 'param-value required');
          });

          test('If required then not optional', () => {
            let result = element._computeRowClass({required: true}, true);
            assert.equal(result, 'param-value required');
          });

          test('Returns optional name', () => {
            let result = element._computeRowClass({required: false}, true);
            assert.equal(result, 'param-value optional');
          });

          test('Ignores optional if can\'t has optional', () => {
            let result = element._computeRowClass({required: false}, false);
            assert.equal(result, 'param-value');
          });

          test('Has opened class', () => {
            let result = element._computeRowClass({}, true, true);
            assert.equal(result, 'param-value optional with-optional');
          });
        });

        suite('_computeTypeClass()', () => {
          let element;
          suiteSetup(() => {
            element = fixture('basic');
          });

          test('Returns "is-array" class', () => {
            let result = element._computeTypeClass(true);
            assert.equal(result, 'is-array');
          });

          test('Returns empty class', () => {
            let result = element._computeTypeClass(false);
            assert.equal(result, '');
          });
        });

        suite('toggleOptionalParams()', () => {
          let element;
          suiteSetup(() => {
            element = fixture('basic');
          });

          test('Ignores the state when allowHideOptional is not set', () => {
            element.toggleOptionalParams();
            assert.isFalse(element.optionalOpened);
            element.toggleOptionalParams();
            assert.isFalse(element.optionalOpened);
          });

          test('Toggles property when allowed', () => {
            element.allowHideOptional = true;
            element.toggleOptionalParams();
            assert.isTrue(element.optionalOpened);
            element.toggleOptionalParams();
            assert.isFalse(element.optionalOpened);
          });
        });

        suite('Basics', () => {
          test('_getForm() returns form handler', () => {
            const element = fixture('basic');
            const result = element._getForm();
            assert.isOk(result);
          });

          test('optionalOpened is false by default', () => {
            const element = fixture('basic');
            assert.isFalse(element.optionalOpened);
          });

          test('Renders title', () => {
            const element = fixture('withTitle');
            const header = element.shadowRoot.querySelector('h3');
            assert.equal(header.innerText, 'test-title');
          });

          test('Renders optional checkbox', (done) => {
            const element = fixture('allowHideOptional');
            element.model = [{
              binding: 'query',
              name: 'access_token',
              hasDescription: true,
              description: 'test',
              required: false,
              schema: {
                enabled: true,
                type: 'string',
                inputLabel: 'access_token',
                isEnum: false,
                isArray: false,
                isBool: false,
                inputType: 'text'
              },
              value: 'access_token-value'
            }];
            flush(() => {
              const node = element.shadowRoot.querySelector('.toggle-checkbox');
              assert.ok(node);
              done();
            });
          });
        });

        suite('With model', () => {
          // let queryModel;
          suite('Basics', () => {
            let element;
            let uriModel;
            setup((done) => {
              uriModel = {
                binding: 'query',
                name: 'file',
                hasDescription: true,
                description: 'test',
                required: true,
                schema: {
                  enabled: true,
                  type: 'string',
                  inputLabel: 'file',
                  isEnum: false,
                  isArray: false,
                  isBool: false,
                  inputType: 'text'
                },
                value: 'file-test-value'
              };
              // queryModel = {
              //   binding: 'query',
              //   name: 'access_token',
              //   hasDescription: true,
              //   description: 'test',
              //   required: true,
              //   schema: {
              //     enabled: true,
              //     type: 'string',
              //     inputLabel: 'access_token',
              //     isEnum: false,
              //     isArray: false,
              //     isBool: false,
              //     inputType: 'text'
              //   },
              //   value: 'access_token-value'
              // };

              element = fixture('uriModel');
              element.model = [uriModel];
              flush(() => done());
            });

            test('Renders form elements', () => {
              const nodes = element.shadowRoot.querySelectorAll('.param-value');
              assert.equal(nodes.length, 1);
            });
          });

          suite('Optional parameters', () => {
            let element;
            let queryModel;
            setup((done) => {
              queryModel = [{
                binding: 'query',
                name: 'access_token',
                hasDescription: true,
                description: 'test',
                required: true,
                schema: {
                  enabled: true,
                  type: 'string',
                  inputLabel: 'access_token',
                  isEnum: false,
                  isArray: false,
                  isBool: false,
                  inputType: 'text'
                },
                value: 'access_token-value'
              }, {
                binding: 'query',
                name: 'access_token2',
                hasDescription: true,
                description: 'test',
                required: false,
                schema: {
                  enabled: true,
                  type: 'string',
                  inputLabel: 'access_token',
                  isEnum: false,
                  isArray: false,
                  isBool: false,
                  inputType: 'text'
                },
                value: 'access_token-value-2'
              }];

              element = fixture('queryModel');
              element.model = queryModel;
              flush(() => done());
            });

            test('Renders form elements', () => {
              const nodes = element.shadowRoot.querySelectorAll('.param-value');
              assert.equal(nodes.length, 2);
            });

            test('Second is hidden', () => {
              const nodes = element.shadowRoot.querySelectorAll('.param-value');
              const display = getComputedStyle(nodes[1]).display;
              assert.equal(display, 'none');
            });

            test('Renders hidden when optional not allowed', () => {
              element.allowHideOptional = false;
              const nodes = element.shadowRoot.querySelectorAll('.param-value');
              const display = getComputedStyle(nodes[1]).display;
              assert.notEqual(display, 'none');
            });
          });
        });

        suite('Custom parameters', () => {
          let element;
          setup((done) => {
            element = fixture('custom');
            flush(() => done());
          });

          test('Renders add parameter button', () => {
            const button = element.shadowRoot.querySelector('.add-action');
            assert.isOk(button);
          });

          test('addCustom() adds new item', () => {
            element.addCustom();
            assert.typeOf(element.model, 'array');
            assert.lengthOf(element.model, 1);
          });

          test('Clicking on the button adds new viewd', (done) => {
            const button = element.shadowRoot.querySelector('.add-action .action-button');
            MockInteractions.tap(button);
            flush(() => {
              const custom = element.shadowRoot.querySelector('api-url-params-custom-input');
              assert.ok(custom);
              done();
            });
          });

          test('Delete icon removes the parameter', (done) => {
            element.addCustom();
            flush(() => {
              const button = element.shadowRoot.querySelector('.delete-icon');
              MockInteractions.tap(button);
              assert.lengthOf(element.model, 0);
              done();
            });
          });
        });
      });
    </script>

  </body>
</html>
