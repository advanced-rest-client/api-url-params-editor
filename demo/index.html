<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
  <title>api-url-params-editor demo</title>
  <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
  <link rel="import" href="../../iron-demo-helpers/demo-pages-shared-styles.html">
  <link rel="import" href="../../iron-demo-helpers/demo-snippet.html">
  <link rel="import" href="../../paper-button/paper-button.html">
  <link rel="import" href="../../api-view-model-transformer/api-view-model-transformer.html">
  <link rel="import" href="../api-url-params-editor.html">
  <custom-style>
    <style is="custom-style" include="demo-pages-shared-styles">
    :root {
      --arc-font-body1: {
        @apply --paper-font-body1;
      }
    }

    h1 {
      @apply --paper-font-headline;
    }

    h2 {
      @apply --paper-font-title;
    }

    h3 {
      @apply --paper-font-subhead;
    }

    output {
      white-space: pre-wrap;
      @apply --paper-font-code1;
      font-size: 16px;
    }
    </style>
  </custom-style>
</head>
<body>
  <header>
    <h1>API URL params editor<h1>
  </header>
  <dom-bind id="demo">
    <template is="dom-bind">
      <api-view-model-transformer amf-model="[[queryAmfModel]]" view-model="{{queryModel}}"></api-view-model-transformer>
      <api-view-model-transformer amf-model="[[uriAmfModel]]" view-model="{{uriModel}}"></api-view-model-transformer>
      <div class="vertical-section-container" role="main">
        <api-url-params-editor query-model="[[queryModel]]" uri-model="[[uriModel]]" on-query-value-changed="_queryValueChanged" on-uri-value-changed="_uriValueChanged" allow-custom></api-url-params-editor>
      </div>
      <div class="vertical-section-container" role="region" aria-labelledby="outputTitle">
        <h2 id="outputTitle">Produced output</h2>
        <p>Element produces <code>queryValue</code>, <code>uriValue</code> properties and dispatches change events.</p>
        <h3>Query parametrs</h3>
        <output>[[queryValueString]]</output>
        <h3>URI parametrs</h3>
        <output>[[uriValueString]]</output>
        <h3>Events log</h3>
        <div>
          <paper-button raised on-tap="clearEventsLog">Clear log</paper-button><br/>
          <output>[[eventsLog]]</output>
        </div>
      </div>
    </template>
  </dom-bind>
  <script>
  (function(scope) {
    scope._queryValueChanged = function(e) {
      let queryValue = e.detail.value;
      let result;
      if (queryValue) {
        result = JSON.stringify(queryValue);
      } else {
        result = '';
      }
      scope.set('queryValueString', result);
    };
    scope._uriValueChanged = function(e) {
      let uriValue = e.detail.value;
      let result;
      if (uriValue) {
        result = JSON.stringify(uriValue);
      } else {
        result = '';
      }
      scope.set('uriValueString', result);
    };
    /**
     * Extracts query parameters from the AMF data model by traversing
     * the model up to the given id which represents method id.
     *
     * This is not a real function. You would like to implement on tree
     * traversing to search for all available query parameters.
     *
     * This example uses resolved AMF model.
     *
     * @param {String} model Method ID.
     * @return {Array} Combined array of all query parameters that can be
     * applied to the method. That incluses security schemes, traits, resource
     * types, endpoint and method.
     */
    function extractQueryParameters(model) {
      model = model[0]['http://raml.org/vocabularies/document#encodes'][0];
      model = model['http://raml.org/vocabularies/http#endpoint'][0];
      const op = model['http://www.w3.org/ns/hydra/core#supportedOperation'][0];
      const expects = op['http://www.w3.org/ns/hydra/core#expects'][0];
      let result = expects['http://raml.org/vocabularies/http#parameter'];
      const sec = op['http://raml.org/vocabularies/security#security'][0];
      const oauthParams = sec['http://raml.org/vocabularies/http#parameter'];
      // ext = ext['http://raml.org/vocabularies/document#dataNode'][0];
      // ext = ext['http://raml.org/vocabularies/data#queryParameters'];
      return result.concat(oauthParams);
    }

    function extractUriParameters(model) {
      model = model[0]['http://raml.org/vocabularies/document#encodes'][0];
      model = model['http://raml.org/vocabularies/http#endpoint'][0];
      return model['http://raml.org/vocabularies/http#parameter'];
    }
    scope._load = function() {
      fetch('./parameters-model.json')
      .then((response) => response.json())
      .then((data) => {
        scope.queryAmfModel = extractQueryParameters(data);
        scope.uriAmfModel = extractUriParameters(data);
      });
    };
    scope._logEvent = function(type, name, value) {
      let log = '[' + new Date().toGMTString() + ']: ';
      log += type + ' model changed: ' + name + '=' + value + '\n';
      let scopelog = scope.eventsLog;
      if (!scopelog) {
        scopelog = '';
      }
      scopelog += log;
      scope.eventsLog = scopelog;
    };
    scope.clearEventsLog = function() {
      scope.eventsLog = '';
    };
    window.addEventListener('uri-parameter-changed', (e) => {
      console.log('uri-parameter-changed', e.detail.name, e.detail.value);
      scope._logEvent('Uri', e.detail.name, e.detail.value);
    });
    window.addEventListener('query-parameter-changed', (e) => {
      console.log('query-parameter-changed', e.detail.name, e.detail.value);
      scope._logEvent('Query', e.detail.name, e.detail.value);
    });
    window.addEventListener('WebComponentsReady', function() {
      scope._load();
    });
  })(document.getElementById('demo'));
  </script>
</body>
</html>
