<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
  <title>api-url-params-editor demo</title>
  <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
  <link rel="import" href="../../iron-demo-helpers/demo-pages-shared-styles.html">
  <link rel="import" href="../../iron-demo-helpers/demo-snippet.html">
  <link rel="import" href="../../api-view-model-transformer/api-view-model-transformer.html">
  <link rel="import" href="../api-url-params-editor.html">
  <custom-style>
    <style is="custom-style" include="demo-pages-shared-styles">
    h2 {
      @apply --paper-font-title;
    }

    output {
      white-space: pre-wrap;
      @apply --paper-font-code1;
    }
    </style>
  </custom-style>
</head>

<body>
  <dom-bind id="demo">
    <template is="dom-bind">
      <api-view-model-transformer amf-model="[[queryAmfModel]]" view-model="{{queryModel}}"></api-view-model-transformer>
      <api-view-model-transformer amf-model="[[uriAmfModel]]" view-model="{{uriModel}}"></api-view-model-transformer>
      <div class="vertical-section-container">
        <api-url-params-editor query-model="[[queryModel]]" uri-model="[[uriModel]]" on-query-value-changed="_queryValueChanged" on-uri-value-changed="_uriValueChanged"></api-url-params-editor>
        <h2>Query parametrs</h2>
        <output>[[queryValueString]]</output>
        <h2>URI parametrs</h2>
        <output>[[uriValueString]]</output>
      </div>
    </template>
  </dom-bind>
  <script>
  (function(scope) {
    scope._queryValueChanged = function(e) {
      let queryValue = e.detail.value;
      let result;
      if (queryValue) {
        result = JSON.stringify(queryValue);
      } else {
        result = '';
      }
      scope.set('queryValueString', result);
    };
    scope._uriValueChanged = function(e) {
      let uriValue = e.detail.value;
      let result;
      if (uriValue) {
        result = JSON.stringify(uriValue);
      } else {
        result = '';
      }
      scope.set('uriValueString', result);
    };
    /**
     * Extracts query parameters from the AMF data model by traversing
     * the model up to the given id which represents method id.
     *
     * This is not a real function. You would like to implement on tree
     * traversing to search for all available query parameters.
     *
     * @param {String} model Method ID.
     * @return {Array} Combined array of all query parameters that can be
     * applied to the method. That incluses security schemes, traits, resource
     * types, endpoint and method.
     */
    function extractQueryParameters(model) {
      model = model[0]['http://raml.org/vocabularies/document#encodes'][0];
      model = model['http://raml.org/vocabularies/http#endpoint'][0];
      model = model['http://www.w3.org/ns/hydra/core#supportedOperation'][0];
      const expects = model['http://www.w3.org/ns/hydra/core#expects'][0];
      // let ext = model['http://raml.org/vocabularies/document#extends'][0];
      let result = expects['http://raml.org/vocabularies/http#parameter'];
      // ext = ext['http://raml.org/vocabularies/document#target'][0];
      // ext = ext['http://raml.org/vocabularies/document#dataNode'][0];
      // ext = ext['http://raml.org/vocabularies/data#queryParameters'];
      return result;
    }

    function extractUriParameters(model) {
      model = model[0]['http://raml.org/vocabularies/document#encodes'][0];
      model = model['http://raml.org/vocabularies/http#endpoint'][0];
      return model['http://raml.org/vocabularies/http#parameter'];
    }
    scope._load = function() {
      fetch('./parameters-model.json')
      .then((response) => response.json())
      .then((data) => {
        scope.queryAmfModel = extractQueryParameters(data);
        scope.uriAmfModel = extractUriParameters(data);
      });
    };
    window.addEventListener('uri-parameter-changed', (e) => {
      console.log('uri-parameter-changed', e.detail.name, e.detail.value);
    });
    window.addEventListener('query-parameter-changed', (e) => {
      console.log('query-parameter-changed', e.detail.name, e.detail.value);
    });
    window.addEventListener('WebComponentsReady', function() {
      scope._load();
    });
  })(document.getElementById('demo'));
  </script>
</body>
</html>
